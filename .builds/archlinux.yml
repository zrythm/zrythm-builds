#
# Copyright (C) 2020-2022 Alexandros Theodotou <alex at zrythm dot org>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

image: archlinux
sources:
  - https://git.sr.ht/~alextee/zrythm
  - https://git.sr.ht/~alextee/zplugins
  - https://git.sr.ht/~alextee/zrythm-installer
  - https://github.com/mesonbuild/meson
secrets:
  - 063cb70d-6da6-492a-b530-04edc07651ba
  - 10b48de1-2cfb-4112-b215-080444177c46
  - 7c85cca9-3e6f-4c7c-ba42-b44ca7379585
tasks:
  - install-packages: |
      sudo pacman -Syy
      sudo pacman -S --noconfirm archlinux-keyring
      sudo pacman -S --noconfirm --needed aws-cli boost ccache cmake gtk2 gtk4 gtksourceview5 chromaprint curl lilv libx11 jack breeze-icons libsndfile libyaml libsamplerate alsa-lib fftw suil flatpak flatpak-builder ffmpeg python gettext sed ninja help2man python-sphinx ladspa libadwaita jq lv2 npm graphviz pcre2 rubberband rtaudio rtmidi python-pip xdg-utils lcov gcovr zstd texlive-langjapanese tar zip unzip rsync lzip ruby gperf intltool qt5-base patchelf p7zip ruby-sass sassc wget vamp-plugin-sdk vim wayland-protocols xxhash
      sudo pacman -Syu --noconfirm
      yay -S --noconfirm carla-git
  - install-texlive: |
      sudo sed -i '1iServer = http://mirror.lty.me/archlinux/$repo/os/$arch' /etc/pacman.d/mirrorlist
      sudo pacman -S --noconfirm --needed texlive-meta
  - make-archlinux: |
      # make sure pkg suffix is .pkg.tar.zst
      echo "PKGEXT='.pkg.tar.zst'" | sudo tee -a /etc/makepkg.conf
      #sudo pip3 install meson sphinx-intl furo sphinx-copybutton sphinxcontrib-svg2pdfconverter
      python -m venv venv
      . ~/venv/bin/activate
      pip install -r zrythm/requirements.txt
      pip install meson
      pip install ninja
      export PATH=$PATH:/home/build/.local/bin
      export MESON_PATH=meson
      zrythm-builds/scripts/make-pkg.sh archlinux arch-pkg
      zrythm-builds/scripts/make-pkg.sh archlinux
  - deploy-archlinux: |
      zrythm-builds/scripts/push-pkg.sh archlinux
  - create-and-deploy-manuals: |
      zrythm-builds/scripts/create-manuals-zip.sh archlinux /tmp/artifacts/user-manual
      zrythm-builds/scripts/push-pkg.sh user-manual
      #- cleanup_space: |
      #sudo pacman -R --noconfirm texlive-langjapanese texlive-meta
