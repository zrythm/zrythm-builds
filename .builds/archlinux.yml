image: archlinux
packages:
  - meson
  - gtk3
  - chromaprint
  - lilv
  - libx11
  - jack
  - breeze-icons
  - libsndfile
  - libyaml
  - libsamplerate
  - alsa-lib
  - fftw
  - suil
  - ffmpeg
  - python
  - gettext
  - gtksourceview4
  - sed
  - ninja
  - help2man
  - python-sphinx
  - ladspa
  - jq
  - lv2
  - graphviz
  - rubberband
  - xdg-utils
  - lcov
  - gcovr
  - zstd
  - rtaudio
  - rtmidi
  - texlive-most
  - tar
  - zip
  - unzip
  - rsync
  - lzip
  - ruby
  - gperf
  - intltool
  - p7zip
  - wget
sources:
  - https://git.sr.ht/~alextee/zrythm
  - https://git.sr.ht/~alextee/zplugins
  - https://gitlab.gnome.org/GNOME/gtk
  - https://git.sr.ht/~alextee/mxe
  - https://git.sr.ht/~alextee/zrythm-installer
  - https://github.com/mesonbuild/meson
  - https://github.com/KDE/breeze-icons
secrets:
  - 063cb70d-6da6-492a-b530-04edc07651ba
tasks:
  - make-archlinux: |
      zrythm-builds/scripts/make-pkg.sh archlinux
  - deploy-archlinux: |
      distro=archlinux
      zrythm-builds/scripts/push-pkg.sh $distro
      # deploy manuals
      source scripts/common.sh.in
      for lang in $linguas ; do
        $scp_cmd \
          "zrythm-installer/build/zrythm-$zrythm_pkg_ver/build/doc/user/$lang/latex/Zrythm.pdf" \
          "$remote_ip:$remote_home/manual/Zrythm-$zrythm_pkg_ver-$lang.pdf"
      done
  - make-windows: |
      # install wine
      sudo sh -c 'echo "[multilib]" >> /etc/pacman.conf'
      sudo sh -c 'echo "Include = /etc/pacman.d/mirrorlist" >> /etc/pacman.conf'
      sudo pacman -Syu --noconfirm
      sudo pacman -S --noconfirm wine
      wget https://www.zrythm.org/downloads/inno-setup-bin.zip
      # install inno
      unzip inno-setup-bin.zip -d ~/
      # create manuals zip
      distro=windows10
      source scripts/common.sh.in
      for lang in $linguas ; do
        $scp_cmd \
          "$remote_ip:$remote_home/manual/Zrythm-$zrythm_pkg_ver-$lang.pdf" \
          "zrythm-installer/build/"
      done
      pushd "zrythm-installer/build"
      zip user-manual.zip ./*.pdf
      popd
      zrythm-builds/scripts/make-pkg.sh windows10
  - deploy-windows: |
      zrythm-builds/scripts/push-pkg.sh windows10
  - deploy: |
      zrythm-builds/scripts/deploy-windows-installer.sh archlinux
  - gen-gnu-linux-installers: |
      timeout 1800 zrythm-builds/scripts/zip-gnu-linux-packages.sh
  - deploy-gnu-linux-installers-to-server: |
      zrythm-builds/scripts/deploy-installers.sh
  - deploy-to-sendowl: |
      zrythm-builds/scripts/send-to-sendowl.sh
